{% extends "base.html" %}

{% block title %}Manage Membership{% endblock %}

{% block content %}
<div class="container-fluid py-4" id="manage-app">
    <!-- Header Section -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 fw-bold text-gray-800 mb-1">Manage Membership</h1>
            <p class="text-muted mb-0">
                Task Force: <span class="fw-semibold text-dark">{{ taskforce.name }}</span>
            </p>
        </div>
        <div>
            <span class="badge rounded-pill bg-white text-dark border px-3 py-2 shadow-sm">
                <i
                    class="bi bi-circle-fill text-{{ taskforce.status|lower|yesno:'success,secondary,warning' }} me-1 small"></i>
                {{ taskforce.get_status_display }}
            </span>
        </div>
    </div>

    <div class="row g-4">
        <!-- LEFT PANEL: Actions -->
        <div class="col-lg-4">
            <!-- Instructions Card -->
            <div class="card border-0 shadow-sm mb-4 bg-primary-subtle">
                <div class="card-body">
                    <div class="d-flex">
                        <i class="bi bi-info-circle-fill text-primary fs-4 me-3"></i>
                        <div>
                            <h6 class="fw-bold text-primary mb-1">Workflow Guide</h6>
                            <p class="small text-muted mb-0">
                                1. Add members to the roster.<br>
                                2. Monitor workload impact.<br>
                                3. If <strong>Overloaded</strong>, justification is required.<br>
                                4. Submit for PSM approval.
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Add Member Card -->
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-bottom-0 pt-4 pb-0">
                    <h6 class="fw-bold mb-0">Add Member</h6>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label text-uppercase small fw-bold text-muted tracking-wide">Select
                            Lecturer</label>
                        <div class="input-group">
                            <select class="form-select form-select-sm bg-light border-0 small" id="memberSelect">
                                <option value="">Loading staff...</option>
                                <!-- Populated via API -->
                            </select>
                            <button type="button" class="btn btn-primary px-4" id="addMemberBtn">
                                <i class="bi bi-plus-lg"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Live Preview Box -->
                    <div id="selection-preview" class="min-h-50">
                        <!-- Content injected via JS -->
                    </div>
                </div>
            </div>

            <!-- Task Force Stats -->
            <div class="card border-0 shadow-sm mt-4">
                <div class="card-body d-flex align-items-center justify-content-between">
                    <span class="text-muted fw-medium">Task Force Weightage</span>
                    <span class="badge bg-dark rounded-pill px-3 py-2">{{ taskforce.weightage }} Points</span>
                </div>
            </div>
        </div>

        <!-- RIGHT PANEL: Current Roster -->
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white border-bottom py-3 d-flex justify-content-between align-items-center">
                    <h5 class="fw-bold mb-0">Current Members</h5>
                    <span class="badge bg-light text-secondary border" id="count-badge">0 Assigned</span>
                </div>

                <form method="post" id="mainForm" class="d-flex flex-column h-100">
                    {% csrf_token %}
                    <!-- Hidden inputs for state sync -->
                    <div id="hidden-inputs">
                        <select name="members" id="id_members" multiple class="d-none">
                            {% for id in form.members.value %}
                            <option value="{{ id }}" selected>{{ id }}</option>
                            {% endfor %}
                        </select>
                        <input type="hidden" name="justification" id="id_justification">
                        <input type="hidden" name="action" id="form-action" value="">
                    </div>

                    <div class="table-responsive flex-grow-1">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="bg-light text-secondary text-uppercase text-xs tracking-wide">
                                <tr>
                                    <th class="ps-4 py-3 border-0 small" style="width: 40%">Member</th>
                                    <th class="py-3 border-0" style="width: 35%">Workload Status</th>
                                    <th class="text-end pe-4 py-3 border-0">Action</th>
                                </tr>
                            </thead>
                            <tbody id="roster-body" class="border-top-0">
                                <!-- Populated via JS -->
                            </tbody>
                        </table>

                        <!-- Empty State (Visible when 0 members) -->
                        <div id="empty-state" class="text-center py-5 d-none">
                            <div class="mb-3 text-muted opacity-50">
                                <i class="bi bi-people fs-1"></i>
                            </div>
                            <h6 class="text-muted">No members assigned yet</h6>
                            <p class="small text-muted">Use the panel on the left to add staff.</p>
                        </div>
                    </div>

                    <!-- Footer Actions -->
                    <div class="card-footer bg-white mt-auto py-3 border-top">
                        <div class="d-flex justify-content-end gap-2">
                            <a href="{% url 'dashboard:hod_taskforce_list' %}"
                                class="btn btn-light text-muted">Cancel</a>

                            {% if taskforce.status == 'ACTIVE' or taskforce.status == 'DRAFT' or taskforce.status == 'REJECTED' %}
                            <button type="button" onclick="submitForm('save_draft')" class="btn btn-outline-secondary">
                                Save Draft
                            </button>
                            <button type="button" onclick="trySubmit()" class="btn btn-primary px-4 fw-bold">
                                {% if taskforce.status == 'SUBMITTED' %}
                                Update Submission
                                {% else %}
                                Submit for Approval
                                {% endif %}
                            </button>
                            {% else %}
                            <button disabled class="btn btn-secondary">
                                <i class="bi bi-lock-fill me-1"></i> Locked
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Justification Modal -->
<div class="modal fade" id="justificationModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title fw-bold"><i class="bi bi-exclamation-triangle-fill"></i> Overload Warning</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>One or more assigned members are currently <strong>Overloaded</strong>.</p>
                <p class="small text-muted">To proceed with submission, you must provide a justification for this
                    assignment.</p>
                <div class="mb-3">
                    <label class="form-label fw-bold">Justification / Remarks:</label>
                    <textarea class="form-control" id="modal-justification-text" rows="3"
                        placeholder="Explain why this assignment is necessary..."></textarea>
                    <div class="invalid-feedback d-block" id="modal-error" style="display:none !important;">Please
                        provide a justification.</div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning fw-bold" onclick="confirmSubmitWithJustification()">Confirm
                    & Submit</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // State
    const API_URL = "{% url 'dashboard:staff_list_api' %}?department_id={{ request.user.department.id|default:'' }}";
    const TF_WEIGHT = {{ taskforce.weightage }};
    const TF_STATUS = "{{ taskforce.status }}";
    const COUNTS_IN_WORKLOAD = ['ACTIVE', 'DRAFT', 'SUBMITTED', 'APPROVED'].includes(TF_STATUS);

    // Preloaded members (includes those outside HOD's department)
    const PRELOADED_MEMBERS = {{ current_members_json| safe }};
    const preloadedMemberIds = new Set(PRELOADED_MEMBERS.map(m => String(m.id)));

    let staffRegistry = {}; // ID -> Member Object (Global lookup)
    let selectedMembers = new Set(); // Set of IDs
    let candidateList = []; // Department candidates for dropdown

    // Elements
    const rosterBody = document.getElementById('roster-body');
    const memberSelect = document.getElementById('memberSelect');
    const countBadge = document.getElementById('count-badge');
    const previewDiv = document.getElementById('selection-preview');

    // -- Init --
    document.addEventListener('DOMContentLoaded', async () => {
        // 1. Initialize Registry with existing members
        PRELOADED_MEMBERS.forEach(m => {
            addToRegistry(m);
            selectedMembers.add(String(m.id));
        });

        // 2. Render initial roster immediately (no wait for API)
        renderRoster();

        // 3. Load candidates for dropdown
        await loadStaff();
    });

    // Listeners
    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('addMemberBtn').addEventListener('click', () => {
            const id = memberSelect.value;
            if (id) addMember(id);
        });

        memberSelect.addEventListener('change', (e) => {
            const id = e.target.value;
            updatePreview(id);
        });
    });

    function addToRegistry(member) {
        // key by ID (string to be safe)
        staffRegistry[member.id] = member;
    }

    async function loadStaff() {
        try {
            const res = await fetch(API_URL);
            const data = await res.json();

            // Add candidates to registry (if not already there)
            data.staff.forEach(s => addToRegistry(s));
            candidateList = data.staff;

            // Populate Dropdown with candidates
            populateDropdowns(candidateList);
        } catch (e) {
            console.error("Failed to load staff", e);
            alert("Error loading staff list. Please refresh.");
        }
    }

    function populateDropdowns(candidates) {
        // Clear options
        memberSelect.innerHTML = '<option value="">-- Select Lecturer --</option>';

        candidates.forEach(s => {
            if (selectedMembers.has(String(s.id))) {
                return;
            }
            // Only add if not already selected? Or just add all
            const optM = document.createElement('option');
            optM.value = s.id;
            optM.textContent = s.name;
            memberSelect.appendChild(optM);
        });
    }

    function shouldApplyWeightForMember(id) {
        if (!COUNTS_IN_WORKLOAD) {
            return true;
        }
        return !preloadedMemberIds.has(String(id));
    }

    function getWorkloadImpact(workload, applyWeight) {
        if (!workload) {
            return { status: 'UNKNOWN', message: 'Workload unavailable' };
        }

        const current = workload.current_weightage;
        const min = workload.min_weightage;
        const max = workload.max_weightage;

        if (current == null || min == null || max == null) {
            return { status: workload.status, message: workload.message || 'Workload unavailable' };
        }

        const predicted = current + (applyWeight ? TF_WEIGHT : 0);
        let status = 'BALANCED';
        if (predicted > max) {
            status = 'OVERLOADED';
        } else if (predicted < min) {
            status = 'UNDERLOADED';
        }

        const label = status === 'OVERLOADED'
            ? 'Overloaded'
            : status === 'UNDERLOADED'
                ? 'Underloaded'
                : 'Balanced';

        return {
            status: status,
            message: `${label} (${predicted}/${max})`
        };
    }

    function getMembershipState(memberId) {
        if (preloadedMemberIds.has(String(memberId))) {
            if (TF_STATUS === 'SUBMITTED') {
                return { label: 'Pending review', badge: 'bg-warning text-dark' };
            }
            if (TF_STATUS === 'DRAFT') {
                return { label: 'Draft saved', badge: 'bg-secondary' };
            }
            return { label: 'Already added', badge: 'bg-primary' };
        }
        return { label: 'New (unsaved)', badge: 'bg-info text-dark' };
    }

    function updatePreview(id) {
        const previewEl = document.getElementById('selection-preview');
        if (!id) {
            previewEl.innerHTML = `
                <div class="text-center py-4 bg-light rounded mt-3 border border-dashed">
                    <div class="text-muted small">Select a lecturer to view their workload status</div>
                </div>
            `;
            return;
        }
        const s = staffRegistry[id];
        if (!s) return;

        const applyWeight = shouldApplyWeightForMember(id) && !selectedMembers.has(String(id));
        const currentImpact = getWorkloadImpact(s.workload, false);
        const predictedImpact = getWorkloadImpact(s.workload, applyWeight);

        let badge = getBadge(predictedImpact.status);
        let icon = predictedImpact.status === 'OVERLOADED' ? 'exclamation-triangle-fill' : 'check-circle-fill';

        previewEl.innerHTML = `
            <div class="card border mt-3 bg-light animate__animated animate__fadeIn">
                <div class="card-body p-3">
                    <div class="d-flex align-items-center mb-2">
                        <span class="badge ${badge} me-2"><i class="bi bi-${icon}"></i> ${predictedImpact.status}</span>
                    </div>
                    <div class="small">
                        <strong>Current:</strong> ${currentImpact.message}
                    </div>
                    ${applyWeight ? `
                    <div class="small mt-1">
                        <strong>After add:</strong> ${predictedImpact.message}
                    </div>
                    <div class="small text-muted mt-1">
                        + ${TF_WEIGHT} (Task Force)
                    </div>` : ''}
                </div>
            </div>
        `;
    }

    // -- Actions --

    function addMember(id) {
        // Prevent duplicates
        if (selectedMembers.has(id)) {
            alert("Member already added.");
            return;
        }

        selectedMembers.add(id);
        memberSelect.value = ""; // Reset dropdown
        previewDiv.innerHTML = "";
        populateDropdowns(candidateList);
        renderRoster();
    }

    function removeMember(id) {
        selectedMembers.delete(id);
        populateDropdowns(candidateList);
        renderRoster();
    }

    function renderRoster() {
        rosterBody.innerHTML = '';
        let count = 0;
        let hasOverload = false;

        // Render Members
        selectedMembers.forEach(id => {
            const s = staffRegistry[id]; // Look up in global registry
            if (s) {
                const row = createRow(s, 'Member');
                rosterBody.appendChild(row.el);
                if (row.isOverloaded) hasOverload = true;
                count++;
            }
        });

        countBadge.textContent = `${count} Members`;
        const emptyState = document.getElementById('empty-state');
        if (emptyState) {
            emptyState.classList.toggle('d-none', count !== 0);
        }
        return hasOverload;
    }

    function createRow(staff, roleLabel) {
        const tr = document.createElement('tr');

        const applyWeight = shouldApplyWeightForMember(staff.id);
        const impact = getWorkloadImpact(staff.workload, applyWeight);
        const status = impact.status;
        const msg = impact.message;
        const isOver = status === 'OVERLOADED';
        const badgeClass = getBadge(status);
        const membershipState = getMembershipState(staff.id);

        tr.innerHTML = `
            <td class="ps-4">
                <div class="d-flex align-items-center">
                    <div class="avatar-circle me-3 bg-light text-primary fw-bold d-flex align-items-center justify-content-center rounded-circle" style="width: 40px; height: 40px;">
                        ${getInitials(staff.name)}
                    </div>
                    <div>
                        <div class="fw-bold text-dark small">${staff.name}</div>
                        <div class="small text-muted">${staff.email}</div>
                        ${membershipState ? `
                        <span class="badge ${membershipState.badge} mt-1">${membershipState.label}</span>
                        ` : ''}
                    </div>
                </div>
            </td>
            <td>
                <span class="badge ${badgeClass} rounded-pill px-3 py-2 fw-normal">
                    ${isOver ? '<i class="bi bi-exclamation-triangle-fill me-1"></i>' : '<i class="bi bi-activity me-1"></i>'}
                    ${msg}
                </span>
            </td>
            <td class="text-end pe-4">
                <button type="button" class="btn btn-light btn-sm text-danger hover-bg-danger-subtle" onclick="removeMember('${staff.id}')" title="Remove Member">
                    <i class="bi bi-trash"></i>
                </button>
            </td>
        `;
        return { el: tr, isOverloaded: isOver };
    }

    function getInitials(name) {
        return name.match(/(\b\S)?/g).join("").match(/(^\S|\S$)?/g).join("").toUpperCase();
    }

    function getBadge(status) {
        if (status === 'OVERLOADED') return 'bg-danger';
        if (status === 'UNDERLOADED') return 'bg-warning text-dark';
        return 'bg-success';
    }

    // -- Submit Logic --

    function syncHiddenInputs() {
        const select = document.getElementById('id_members');
        select.innerHTML = ''; // Clear
        selectedMembers.forEach(id => {
            const opt = document.createElement('option');
            opt.value = id;
            opt.selected = true;
            select.appendChild(opt);
        });
    }

    window.submitForm = function (actionType) {
        syncHiddenInputs();
        document.getElementById('form-action').value = actionType;
        document.getElementById('mainForm').submit();
    }

    window.trySubmit = function () {
        const hasOverload = renderRoster(); // Re-check overload status

        if (hasOverload) {
            // Show Modal
            const modal = new bootstrap.Modal(document.getElementById('justificationModal'));
            modal.show();
        } else {
            // Proceed normally
            submitForm('submit');
        }
    }

    window.confirmSubmitWithJustification = function () {
        const text = document.getElementById('modal-justification-text').value;
        if (!text.trim()) {
            document.getElementById('modal-error').style.display = 'block';
            return;
        }

        document.getElementById('id_justification').value = text;

        // Hide modal manually
        const modalEl = document.getElementById('justificationModal');
        const modal = bootstrap.Modal.getInstance(modalEl);
        modal.hide();

        submitForm('submit');
    }
</script>
{% endblock %}
